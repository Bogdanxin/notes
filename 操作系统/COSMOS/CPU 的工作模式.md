# CPU 的工作模式

cpu 有三种工作模式：实模式、保护模式、长模式

## 实模式

实模式的「实」有两种意义：一是**运行真实的指令**，对指令不做区分，**直接执行指令内容**；二是**发往内从地址是真实的**，对任何地址不加限制的发往内存。

由于数据和指令都存储在内存中，所以需要数据或者指令时，就要将这些加载到 cpu 的寄存器中，这时候就需要通过计算的方式获取。

![img](https://raw.githubusercontent.com/Bogdanxin/cloudImage/master/14633ea933972e19f3439eb6aeab3d13.jpg)

如图所示，将段寄存器内容左移 4 位，加上通用寄存器中的值就可以形成地址，通过这个地址访问内存。代码段通过 CS 和 IP 确定，栈段通过 SS 和 SP 确定的。

### 实模式中断

中断是将正在执行的程序暂停，跳转执行其他程序。在机器码上的显示就是将正在执行的代码终止，然后跳转到其他的地址上执行。

在实模式下，就是先保存 CS 和 IP 寄存器，然后将跳转的程序对应栈地址和程序指针装载到的 CS 和 IP。

实模式下的中断产生有两种方式：

1. 中断控制器给 cpu 发送中断信号，cpu 会响应中断信号，从而发生中断。这是硬件中断，不受 cpu 控制，由其他硬件发起。
2. cpu 执行了 INT 指令 ，这个指令通常后面跟一个常数，代表软中断信号。这时软件中断，由软件控制，由执行的软件发起。



为了实现中断，需要在**内存中设置一个中断向量表**，这个表的地址和长度由 CPU 特殊寄存器 IDTR 指向。实模式下，表中的一个条目有代码段地址和段内偏移组成。

![img](https://raw.githubusercontent.com/Bogdanxin/cloudImage/master/e8876e8561b949b8af5d5237e48f8757.jpg)

发生中断，首先根据中断号和 CPU 中的 IDTR 寄存器计算出内存中对应的中断向量表的向量，然后载入**代码段内偏移 CS**和**代码段基地址 IP**。响应中断。



## 保护模式

保护模式相对于实模式有两点进步：

1. 将 CPU 的寄存器和运算单元都扩展为 32 位，这就使其寻址范围为0 ~ 2^32。也就是 4g 的内存地址。
2. 解决了实模式下，CPU 可以不加区分的执行指令，CPU 访问内存之地不加限制的问题。

