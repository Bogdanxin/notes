# 函数调用过程分析

一个 C 函数调用过程如下：

1. 准备阶段
    * 形成栈底，将 ebp 和 esp 同时付为栈底值；
    * 形成栈顶，然后将应该指向栈顶的 esp 重新赋值，真正指向栈顶的地址，这里的栈顶值需要自行判断再修改。  
2. 过程（函数）体
    * 分配局部变量空间，然后赋值，依靠的是栈底的指针位置，进行赋值。
    * 处理具体的逻辑，如果遇到了函数调用，则需要将实参送入到调用函数栈入口参数处，执行 Call 指令，保存返回地址并转到调用函数处。
    * 最后将逻辑处理结果存放到 eax 中，用于被调用方法接收返回值。
3. 结束阶段
    * 退栈，使用 leave 指令或者 pop 指令，将 esp 指针由栈顶指向栈底
    * 取出返回地址，也就是 ret 指令，返回到被调用函数指定位置。



入口参数的位置：

由于函数调用的过程就是压栈的过程，所以说，当有函数调用时：

1. 将参数存放到函数入口处，分别为栈顶、栈顶+4、栈顶+8 ... 分别代表第一个参数、第二个、第三个 ... 这样便于调用函数取。
2. 然后将被调用函数 call 指令的下一条指令地址存放到 栈顶 - 4 处，调用函数会在返回后，直接访问这个地址，进行跳转返回到调用函数。
3. 最后开始执行调用函数，调用函数栈顶就是被调用函数 栈顶 - 8 处，这个就是新函数的栈底位置，然后再按照上面的函数执行操作继续执行。